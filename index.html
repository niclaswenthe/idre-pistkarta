<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>Idre Fj√§ll ‚Äî Pistkarta</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      touch-action: none;
    }

    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #1a1a2e;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    }

    #map-container {
      width: 100%;
      height: 100%;
      overflow: hidden;
      position: relative;
    }

    #map {
      position: absolute;
      transform-origin: 0 0;
      cursor: grab;
      will-change: transform;
    }

    #map:active {
      cursor: grabbing;
    }

    #map img {
      display: block;
      max-width: none;
    }

    /* Positionsmark√∂rer overlay ‚Äî samma storlek som bilden */
    #markers-overlay {
      position: absolute;
      top: 0;
      left: 0;
      pointer-events: none;
    }

    .user-marker {
      position: absolute;
      transform: translate(-50%, -50%);
      pointer-events: none;
      transition: left 0.8s ease-out, top 0.8s ease-out;
    }

    .user-marker-dot {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 3px solid white;
      box-shadow: 0 2px 12px rgba(0,0,0,0.6), 0 0 0 2px rgba(255,255,255,0.6);
      position: relative;
      animation: pulse-dot 1s ease-in-out infinite;
    }

    @keyframes pulse-dot {
      0%, 100% { transform: scale(1); box-shadow: 0 2px 12px rgba(0,0,0,0.6), 0 0 0 2px rgba(255,255,255,0.6); }
      50%       { transform: scale(1.25); box-shadow: 0 2px 18px rgba(0,0,0,0.7), 0 0 0 4px rgba(255,255,255,0.9); }
    }

    /* Yttre expanderande ring 1 */
    .user-marker-dot::before {
      content: '';
      position: absolute;
      inset: -5px;
      border-radius: 50%;
      border: 3px solid white;
      opacity: 0;
      animation: pulse-ring-outer 1s ease-out infinite;
    }

    /* Yttre expanderande ring 2 ‚Äî f√∂rskjuten fas */
    .user-marker-dot::after {
      content: '';
      position: absolute;
      inset: -5px;
      border-radius: 50%;
      border: 2px solid;
      border-color: inherit;
      opacity: 0;
      animation: pulse-ring-color 1s ease-out 0.5s infinite;
    }

    @keyframes pulse-ring-outer {
      0%   { transform: scale(1);   opacity: 0.9; }
      100% { transform: scale(2.6); opacity: 0;   }
    }

    @keyframes pulse-ring-color {
      0%   { transform: scale(1);   opacity: 0.8; }
      100% { transform: scale(2.2); opacity: 0;   }
    }

    .user-marker-label {
      position: absolute;
      top: -24px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.75);
      color: white;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 600;
      white-space: nowrap;
      letter-spacing: 0.3px;
    }

    .user-marker-lastseen {
      position: absolute;
      top: 28px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.65);
      color: rgba(255,255,255,0.7);
      padding: 1px 6px;
      border-radius: 8px;
      font-size: 9px;
      white-space: nowrap;
      display: none;
    }

    /* Offline-mark√∂r: ingen puls, d√§mpad */
    .user-marker-dot.offline {
      animation: none !important;
      opacity: 0.5;
    }
    .user-marker-dot.offline::before,
    .user-marker-dot.offline::after {
      animation: none !important;
      display: none;
    }

    /* Zoom-knappar ‚Äî nere till h√∂ger, ovanf√∂r joystick */
    .zoom-controls {
      position: fixed;
      bottom: 152px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      z-index: 100;
    }

    .zoom-btn {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      border: none;
      background: rgba(255, 255, 255, 0.92);
      color: #1a1a2e;
      font-size: 32px;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      transition: transform 0.1s ease, background 0.15s ease;
    }

    .zoom-btn:active {
      transform: scale(0.92);
      background: rgba(200, 200, 255, 0.95);
    }

    /* Reset-knapp */
    .reset-btn {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      border: none;
      background: rgba(255, 255, 255, 0.7);
      color: #1a1a2e;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      transition: transform 0.1s ease;
    }

    .reset-btn:active {
      transform: scale(0.92);
    }

    /* Joystick */
    .joystick-container {
      position: fixed;
      bottom: 32px;
      right: 20px;
      z-index: 100;
    }

    .joystick-base {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.25);
      border: 2px solid rgba(255, 255, 255, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .joystick-knob {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.9);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      cursor: grab;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      transition: background 0.15s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .joystick-knob:active {
      background: rgba(200, 200, 255, 0.95);
      cursor: grabbing;
    }

    .joystick-knob::after {
      content: '‚ú¶';
      font-size: 18px;
      color: #1a1a2e;
      opacity: 0.5;
    }

    /* Laddningsmeddelande */
    #loading {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #1a1a2e;
      color: white;
      font-size: 18px;
      z-index: 200;
      gap: 16px;
    }

    #loading.hidden {
      display: none;
    }

    #loading .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255,255,255,0.2);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Placeholder om ingen bild finns */
    #placeholder {
      display: none;
      position: fixed;
      inset: 0;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #1a1a2e;
      color: white;
      text-align: center;
      padding: 32px;
      gap: 16px;
      z-index: 200;
    }

    #placeholder h2 {
      font-size: 24px;
    }

    #placeholder p {
      font-size: 16px;
      opacity: 0.7;
      max-width: 320px;
      line-height: 1.5;
    }

    /* Zoom-niv√• indikator */
    #zoom-level {
      position: fixed;
      top: 16px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.6);
      color: white;
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 14px;
      z-index: 100;
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }

    #zoom-level.visible {
      opacity: 1;
    }

    /* ====== Grupp/session UI ====== */

    /* Grupp-knapp (nere till v√§nster) */
    .group-btn {
      position: fixed;
      bottom: 32px;
      left: 20px;
      z-index: 100;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      border: none;
      background: rgba(255, 255, 255, 0.92);
      color: #1a1a2e;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      transition: transform 0.1s ease, background 0.15s ease;
    }

    .group-btn:active {
      transform: scale(0.92);
      background: rgba(200, 200, 255, 0.95);
    }

    .group-btn.active {
      background: #4CAF50;
      color: white;
    }

    .group-btn .badge {
      position: absolute;
      top: -4px;
      right: -4px;
      background: #f44336;
      color: white;
      font-size: 11px;
      font-weight: 700;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Session-statusbar (√∂verst) */
    .session-bar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      color: white;
      padding: 8px 16px;
      padding-top: calc(env(safe-area-inset-top, 0px) + 8px);
      display: flex;
      align-items: center;
      justify-content: space-between;
      z-index: 150;
      font-size: 14px;
      transform: translateY(-100%);
      transition: transform 0.3s ease;
    }

    .session-bar.visible {
      transform: translateY(0);
    }

    .session-bar .room-code {
      font-weight: 700;
      font-size: 16px;
      letter-spacing: 1px;
    }

    .session-bar .member-count {
      opacity: 0.8;
      font-size: 13px;
    }

    .session-bar .leave-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 13px;
      cursor: pointer;
    }

    /* Modal overlay */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 300;
      padding: 20px;
    }

    .modal-overlay.visible {
      display: flex;
    }

    .modal {
      background: #1e1e32;
      border-radius: 20px;
      padding: 28px 24px;
      max-width: 340px;
      width: 100%;
      color: white;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    .modal h2 {
      font-size: 20px;
      margin-bottom: 6px;
    }

    .modal p {
      font-size: 14px;
      opacity: 0.7;
      margin-bottom: 20px;
      line-height: 1.4;
    }

    .modal label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      opacity: 0.6;
      margin-bottom: 6px;
    }

    .modal input[type="text"] {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid rgba(255, 255, 255, 0.15);
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.08);
      color: white;
      font-size: 16px;
      outline: none;
      margin-bottom: 16px;
      transition: border-color 0.2s;
    }

    .modal input[type="text"]:focus {
      border-color: rgba(255, 255, 255, 0.4);
    }

    .modal input[type="text"]::placeholder {
      color: rgba(255, 255, 255, 0.3);
    }

    .modal .code-input {
      text-align: center;
      font-size: 22px;
      font-weight: 700;
      letter-spacing: 3px;
      text-transform: uppercase;
    }

    .color-picker {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .color-option {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: 3px solid transparent;
      cursor: pointer;
      transition: transform 0.15s, border-color 0.15s;
    }

    .color-option:hover {
      transform: scale(1.1);
    }

    .color-option.selected {
      border-color: white;
      transform: scale(1.15);
    }

    .modal-actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 8px;
    }

    .btn-primary {
      padding: 14px;
      border: none;
      border-radius: 14px;
      background: #4CAF50;
      color: white;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s, transform 0.1s;
    }

    .btn-primary:active {
      transform: scale(0.97);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-secondary {
      padding: 14px;
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 14px;
      background: transparent;
      color: white;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s, transform 0.1s;
    }

    .btn-secondary:active {
      transform: scale(0.97);
      background: rgba(255, 255, 255, 0.1);
    }

    .btn-cancel {
      padding: 10px;
      border: none;
      background: transparent;
      color: rgba(255, 255, 255, 0.5);
      font-size: 14px;
      cursor: pointer;
      text-align: center;
    }

    .divider {
      text-align: center;
      opacity: 0.4;
      font-size: 13px;
      margin: 4px 0;
    }

    /* GPS-status */
    .gps-status {
      position: fixed;
      bottom: 96px;
      left: 20px;
      z-index: 100;
      background: rgba(0, 0, 0, 0.6);
      color: white;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
    }

    .gps-status.visible {
      opacity: 1;
    }

    /* ====== CHATT ====== */

    /* Chatt-knapp (ovanf√∂r grupp-knappen) */
    .chat-btn {
      position: fixed;
      bottom: 100px;
      left: 20px;
      z-index: 100;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      border: none;
      background: rgba(255, 255, 255, 0.92);
      color: #1a1a2e;
      font-size: 24px;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      transition: transform 0.1s ease, background 0.15s ease;
    }

    .chat-btn.visible {
      display: flex;
    }

    .chat-btn:active {
      transform: scale(0.92);
      background: rgba(200, 200, 255, 0.95);
    }

    .chat-btn .chat-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      background: #f44336;
      color: white;
      font-size: 11px;
      font-weight: 700;
      min-width: 20px;
      height: 20px;
      border-radius: 10px;
      padding: 0 4px;
      display: none;
      align-items: center;
      justify-content: center;
    }

    .chat-btn .chat-badge.visible {
      display: flex;
    }

    /* Chatt-panel (slides in fr√•n botten) */
    .chat-panel {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 70vh;
      background: #1e1e32;
      border-radius: 20px 20px 0 0;
      box-shadow: 0 -8px 40px rgba(0, 0, 0, 0.5);
      display: flex;
      flex-direction: column;
      z-index: 250;
      transform: translateY(100%);
      transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
      overflow: hidden;
    }

    .chat-panel.open {
      transform: translateY(0);
    }

    .chat-panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 16px 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      flex-shrink: 0;
    }

    .chat-panel-title {
      color: white;
      font-size: 17px;
      font-weight: 700;
    }

    .chat-close-btn {
      background: rgba(255, 255, 255, 0.12);
      border: none;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      -webkit-tap-highlight-color: transparent;
    }

    /* Meddelandelista */
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 12px 12px 8px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      -webkit-overflow-scrolling: touch;
      scroll-behavior: smooth;
    }

    .chat-messages::-webkit-scrollbar {
      width: 3px;
    }

    .chat-messages::-webkit-scrollbar-track {
      background: transparent;
    }

    .chat-messages::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 2px;
    }

    /* Meddelandebubbla */
    .chat-msg {
      display: flex;
      flex-direction: column;
      max-width: 78%;
    }

    .chat-msg.mine {
      align-self: flex-end;
      align-items: flex-end;
    }

    .chat-msg.theirs {
      align-self: flex-start;
      align-items: flex-start;
    }

    .chat-msg-sender {
      font-size: 11px;
      font-weight: 600;
      margin-bottom: 3px;
      opacity: 0.85;
    }

    .chat-msg-bubble {
      padding: 9px 13px;
      border-radius: 16px;
      font-size: 15px;
      line-height: 1.4;
      color: white;
      word-break: break-word;
    }

    .chat-msg.mine .chat-msg-bubble {
      border-bottom-right-radius: 4px;
    }

    .chat-msg.theirs .chat-msg-bubble {
      border-bottom-left-radius: 4px;
    }

    .chat-msg-time {
      font-size: 10px;
      opacity: 0.45;
      margin-top: 3px;
    }

    /* Bild i chatt */
    .chat-img {
      max-width: 200px;
      max-height: 200px;
      border-radius: 10px;
      display: block;
      cursor: pointer;
      object-fit: cover;
    }

    /* Fil i chatt */
    .chat-file-link {
      display: flex;
      align-items: center;
      gap: 8px;
      color: white;
      text-decoration: none;
      font-size: 14px;
    }

    .chat-file-icon {
      font-size: 20px;
      flex-shrink: 0;
    }

    .chat-file-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .chat-file-name {
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 160px;
    }

    .chat-file-size {
      font-size: 11px;
      opacity: 0.6;
    }

    /* Audio-widget */
    .chat-audio {
      width: 100%;
      max-width: 220px;
      height: 36px;
      border-radius: 8px;
      accent-color: #4CAF50;
    }

    /* Input-rad */
    .chat-input-row {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 10px;
      padding-bottom: calc(10px + env(safe-area-inset-bottom, 0px));
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      flex-shrink: 0;
      background: #1e1e32;
    }

    .chat-input {
      flex: 1;
      background: rgba(255, 255, 255, 0.09);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 20px;
      color: white;
      font-size: 15px;
      padding: 9px 14px;
      outline: none;
      resize: none;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      touch-action: auto;
    }

    .chat-input::placeholder {
      color: rgba(255, 255, 255, 0.3);
    }

    .chat-input:focus {
      border-color: rgba(255, 255, 255, 0.3);
    }

    /* Gemensam stil f√∂r knappar i inputraden */
    .chat-icon-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: none;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      -webkit-tap-highlight-color: transparent;
      transition: background 0.15s, transform 0.1s;
      touch-action: none;
    }

    .chat-icon-btn:active {
      transform: scale(0.9);
      background: rgba(255, 255, 255, 0.2);
    }

    .chat-send-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: none;
      background: #4CAF50;
      color: white;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      -webkit-tap-highlight-color: transparent;
      transition: background 0.15s, transform 0.1s;
    }

    .chat-send-btn:active {
      transform: scale(0.9);
      background: #388E3C;
    }

    .chat-send-btn:disabled {
      background: rgba(255, 255, 255, 0.1);
      cursor: not-allowed;
    }

    /* R√∂stinspelning-indikator */
    .chat-voice-btn.recording {
      background: #f44336;
      animation: voice-pulse 0.8s ease infinite;
    }

    @keyframes voice-pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.12); }
    }

    /* Bifoga-meny */
    .attach-menu {
      position: absolute;
      bottom: 70px;
      left: 10px;
      background: #2a2a45;
      border-radius: 16px;
      padding: 8px;
      display: none;
      flex-direction: column;
      gap: 4px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      z-index: 260;
      min-width: 160px;
    }

    .attach-menu.open {
      display: flex;
    }

    .attach-menu-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 14px;
      border-radius: 10px;
      border: none;
      background: transparent;
      color: white;
      font-size: 15px;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      transition: background 0.15s;
    }

    .attach-menu-item:active {
      background: rgba(255, 255, 255, 0.1);
    }

    /* Bildf√∂rhandsvisning (fullscreen) */
    .img-fullscreen {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.92);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 400;
      padding: 20px;
    }

    .img-fullscreen.visible {
      display: flex;
    }

    .img-fullscreen img {
      max-width: 100%;
      max-height: 100%;
      border-radius: 8px;
      object-fit: contain;
    }

    /* Liten tidsseparator i chatten */
    .chat-day-sep {
      text-align: center;
      font-size: 11px;
      color: rgba(255, 255, 255, 0.35);
      margin: 4px 0;
    }

    /* Medlemslista-knapp */
    .members-btn {
      position: fixed;
      bottom: 168px;
      left: 20px;
      z-index: 100;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      border: none;
      background: rgba(255, 255, 255, 0.92);
      color: #1a1a2e;
      font-size: 24px;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      transition: transform 0.1s ease, background 0.15s ease;
    }
    .members-btn.visible {
      display: flex;
    }
    .members-btn:active {
      transform: scale(0.92);
      background: rgba(200, 200, 255, 0.95);
    }

    /* Medlemslista-panel */
    .members-panel {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      max-height: 55vh;
      background: #1e1e32;
      border-radius: 20px 20px 0 0;
      box-shadow: 0 -8px 40px rgba(0, 0, 0, 0.5);
      display: flex;
      flex-direction: column;
      z-index: 250;
      transform: translateY(100%);
      transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
      overflow: hidden;
    }
    .members-panel.open {
      transform: translateY(0);
    }
    .members-panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 16px 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      flex-shrink: 0;
    }
    .members-panel-title {
      color: white;
      font-size: 17px;
      font-weight: 700;
    }
    .members-list {
      overflow-y: auto;
      padding: 8px 16px 16px;
      -webkit-overflow-scrolling: touch;
    }

    /* Medlemsrad */
    .member-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    }
    .member-row:last-child {
      border-bottom: none;
    }
    .member-dot {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      flex-shrink: 0;
      border: 2px solid rgba(255,255,255,0.3);
    }
    .member-dot.online {
      box-shadow: 0 0 8px currentColor;
      border-color: white;
    }
    .member-info {
      flex: 1;
      min-width: 0;
    }
    .member-name {
      font-size: 15px;
      color: white;
      font-weight: 500;
    }
    .member-status {
      font-size: 12px;
      color: rgba(255,255,255,0.45);
      margin-top: 2px;
    }
    .member-status.online {
      color: #69F0AE;
    }
  </style>
</head>
<body>
  <div id="loading">
    <div class="spinner"></div>
    <span>Laddar pistkarta...</span>
  </div>

  <div id="placeholder">
    <h2>Pistkarta</h2>
    <p>L√§gg kartbilden som <strong>pistkarta.jpg</strong> i samma mapp som denna fil.</p>
    <p style="font-size: 13px; opacity: 0.5;">St√∂der: .jpg, .png, .webp</p>
  </div>

  <div id="map-container">
    <div id="map">
      <img id="map-img" alt="Pistkarta Idre Fj√§ll">
      <div id="markers-overlay"></div>
    </div>
  </div>

  <div id="zoom-level"></div>

  <!-- Session-bar (visas n√§r man √§r i en grupp) -->
  <div class="session-bar" id="session-bar">
    <div>
      <span class="room-code" id="session-room-code"></span>
      <span class="member-count" id="session-member-count"></span>
    </div>
    <button class="leave-btn" id="session-leave">L√§mna</button>
  </div>

  <!-- Grupp-knapp (nere till v√§nster) -->
  <button class="group-btn" id="group-btn">
    <span id="group-btn-icon">üë•</span>
  </button>

  <!-- GPS-status -->
  <div class="gps-status" id="gps-status"></div>

  <div class="zoom-controls">
    <button class="reset-btn" id="zoom-reset" aria-label="√Öterst√§ll vy">‚ü≤</button>
    <button class="zoom-btn" id="zoom-in" aria-label="Zooma in">+</button>
    <button class="zoom-btn" id="zoom-out" aria-label="Zooma ut">‚àí</button>
  </div>

  <div class="joystick-container">
    <div class="joystick-base" id="joystick-base">
      <div class="joystick-knob" id="joystick-knob"></div>
    </div>
  </div>

  <!-- Chatt-knapp (ovanf√∂r grupp-knappen) -->
  <button class="chat-btn" id="chat-btn" aria-label="Gruppchatt">
    <span>üí¨</span>
    <span class="chat-badge" id="chat-badge"></span>
  </button>

  <!-- Medlemslista-knapp (ovanf√∂r chatt-knappen) -->
  <button class="members-btn" id="members-btn" aria-label="Medlemslista">
    <span>üë•</span>
  </button>

  <!-- Medlemslista-panel -->
  <div class="members-panel" id="members-panel">
    <div class="members-panel-header">
      <span class="members-panel-title" id="members-panel-title">Gruppmedlemmar</span>
      <button class="chat-close-btn" id="members-close-btn" aria-label="St√§ng">‚úï</button>
    </div>
    <div class="members-list" id="members-list"></div>
  </div>

  <!-- Chatt-panel -->
  <div class="chat-panel" id="chat-panel">
    <div class="chat-panel-header">
      <span class="chat-panel-title" id="chat-panel-title">Gruppchatt</span>
      <button class="chat-close-btn" id="chat-close-btn" aria-label="St√§ng chatt">‚úï</button>
    </div>
    <div class="chat-messages" id="chat-messages"></div>
    <!-- Bifoga-meny (popup) -->
    <div class="attach-menu" id="attach-menu">
      <button class="attach-menu-item" id="attach-camera">
        <span>üì∑</span><span>Kamera</span>
      </button>
      <button class="attach-menu-item" id="attach-image">
        <span>üñº</span><span>Bild fr√•n bibliotek</span>
      </button>
      <button class="attach-menu-item" id="attach-file">
        <span>üìÑ</span><span>Fil</span>
      </button>
    </div>
    <div class="chat-input-row">
      <button class="chat-icon-btn" id="attach-btn" aria-label="Bifoga">üìé</button>
      <input type="text" class="chat-input" id="chat-input" placeholder="Skriv ett meddelande..." autocomplete="off" maxlength="1000">
      <button class="chat-icon-btn chat-voice-btn" id="voice-btn" aria-label="R√∂stmeddelande">üé§</button>
      <button class="chat-send-btn" id="chat-send-btn" aria-label="Skicka">‚û§</button>
    </div>
  </div>

  <!-- Bildvisare (fullscreen) -->
  <div class="img-fullscreen" id="img-fullscreen">
    <img id="img-fullscreen-img" alt="Bild">
  </div>

  <!-- Dolda fil-inputs -->
  <input type="file" id="file-input-camera" accept="image/*" capture="environment" style="display:none">
  <input type="file" id="file-input-image" accept="image/*" style="display:none">
  <input type="file" id="file-input-file" accept="*/*" style="display:none">

  <!-- Modal: V√§lj √•tg√§rd -->
  <div class="modal-overlay" id="modal-menu">
    <div class="modal">
      <h2>Hitta varandra</h2>
      <p>Skapa en grupp eller g√• med i en befintlig f√∂r att se varandras positioner p√• kartan.</p>
      <div class="modal-actions">
        <button class="btn-primary" id="btn-create-group">Skapa ny grupp</button>
        <div class="divider">eller</div>
        <button class="btn-secondary" id="btn-join-group">G√• med i grupp</button>
        <button class="btn-cancel" id="btn-cancel-menu">Avbryt</button>
      </div>
    </div>
  </div>

  <!-- Modal: Skapa grupp (ange gruppnamn + namn + f√§rg) -->
  <div class="modal-overlay" id="modal-create">
    <div class="modal">
      <h2>Skapa grupp</h2>
      <p>Ge gruppen ett namn, v√§lj ditt namn och f√§rg.</p>
      <label>Gruppnamn</label>
      <input type="text" id="create-group-name" placeholder="T.ex. Skidg√§nget" maxlength="30" autocomplete="off">
      <label>Ditt namn</label>
      <input type="text" id="create-name" placeholder="T.ex. Niclas" maxlength="20" autocomplete="off">
      <label>V√§lj f√§rg</label>
      <div class="color-picker" id="create-colors"></div>
      <div class="modal-actions">
        <button class="btn-primary" id="btn-do-create">Skapa grupp</button>
        <button class="btn-cancel" id="btn-back-create">Tillbaka</button>
      </div>
    </div>
  </div>

  <!-- Modal: G√• med (ange kod + namn + f√§rg) -->
  <div class="modal-overlay" id="modal-join">
    <div class="modal">
      <h2>G√• med i grupp</h2>
      <p>Ange koden som din v√§n delade med dig.</p>
      <label>Gruppkod</label>
      <input type="text" id="join-code" class="code-input" placeholder="XXXX" maxlength="4" autocomplete="off">
      <label>Ditt namn</label>
      <input type="text" id="join-name" placeholder="T.ex. Niclas" maxlength="20" autocomplete="off">
      <label>V√§lj f√§rg</label>
      <div class="color-picker" id="join-colors"></div>
      <div class="modal-actions">
        <button class="btn-primary" id="btn-do-join">G√• med</button>
        <button class="btn-cancel" id="btn-back-join">Tillbaka</button>
      </div>
    </div>
  </div>

  <!-- Modal: Gruppinfo (visa namn, kod, medlemmar) -->
  <div class="modal-overlay" id="modal-info">
    <div class="modal">
      <h2 id="info-room-name">Din grupp</h2>
      <p>Dela l√§nken eller QR-koden med dina v√§nner!</p>
      <div style="text-align:center; margin: 16px 0;">
        <div id="info-room-code" style="font-size: 36px; font-weight: 800; letter-spacing: 4px;"></div>
        <div id="info-share-url" style="font-size: 11px; color: #aaa; margin-top: 4px; word-break: break-all;"></div>
      </div>
      <div style="text-align:center; margin: 8px 0 16px;">
        <div id="info-qr-canvas" style="display:inline-block; border-radius: 8px; overflow:hidden;"></div>
      </div>
      <label>Medlemmar</label>
      <div id="info-members" style="margin-bottom: 16px;"></div>
      <div class="modal-actions">
        <button class="btn-primary" id="btn-share-code">üì§ Dela l√§nk</button>
        <button class="btn-secondary" id="btn-leave-group">L√§mna grupp</button>
        <button class="btn-cancel" id="btn-close-info">St√§ng</button>
      </div>
    </div>
  </div>

  <!-- QR-kod bibliotek -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <!-- Firebase SDK (compat for simplicity in vanilla JS) -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>

  <script>
    // ============================
    // Firebase config (bilbingo-v2 projekt)
    // ============================
    firebase.initializeApp({
      apiKey: "AIzaSyB2N7mFoJ83oOniMtfF3ZkzccnK4FyvfDM",
      authDomain: "bilbingo-b8999.firebaseapp.com",
      databaseURL: "https://bilbingo-b8999-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "bilbingo-b8999",
      storageBucket: "bilbingo-b8999.firebasestorage.app",
      messagingSenderId: "8371565415",
      appId: "1:8371565415:web:3b02df7376cee8c88235c2",
    });
    const db = firebase.database();

    // ============================
    // KART-KONTROLLER (befintlig kod)
    // ============================
    const mapEl = document.getElementById('map');
    const imgEl = document.getElementById('map-img');
    const container = document.getElementById('map-container');
    const loading = document.getElementById('loading');
    const placeholder = document.getElementById('placeholder');
    const zoomLevelEl = document.getElementById('zoom-level');

    let scale = 1;
    let posX = 0;
    let posY = 0;
    let isDragging = false;
    let startX, startY, startPosX, startPosY;
    let zoomTimeout;
    let joystickActive = false;

    const MIN_SCALE = 0.5;
    const MAX_SCALE = 6;
    const ZOOM_STEP = 0.25;

    const imageCandidates = ['pistkarta.webp', 'pistkarta.jpg', 'pistkarta.png'];
    let imageLoaded = false;

    function tryLoadImage(index) {
      if (index >= imageCandidates.length) {
        loading.classList.add('hidden');
        placeholder.style.display = 'flex';
        return;
      }
      const testImg = new Image();
      testImg.onload = function() {
        imageLoaded = true;
        imgEl.src = imageCandidates[index];
        loading.classList.add('hidden');
        fitToScreen();
      };
      testImg.onerror = function() {
        tryLoadImage(index + 1);
      };
      testImg.src = imageCandidates[index];
    }
    tryLoadImage(0);

    function fitToScreen() {
      const cw = container.clientWidth;
      const ch = container.clientHeight;
      const iw = imgEl.naturalWidth;
      const ih = imgEl.naturalHeight;
      scale = Math.min(cw / iw, ch / ih);
      posX = (cw - iw * scale) / 2;
      posY = (ch - ih * scale) / 2;
      updateTransform();
    }

    function updateTransform() {
      mapEl.style.transform = `translate(${posX}px, ${posY}px) scale(${scale})`;
    }

    function showZoomLevel() {
      const percent = Math.round(scale * 100);
      zoomLevelEl.textContent = `${percent}%`;
      zoomLevelEl.classList.add('visible');
      clearTimeout(zoomTimeout);
      zoomTimeout = setTimeout(() => {
        zoomLevelEl.classList.remove('visible');
      }, 1200);
    }

    function zoomAt(delta, cx, cy) {
      const oldScale = scale;
      scale = Math.min(MAX_SCALE, Math.max(MIN_SCALE, scale + delta));
      const ratio = scale / oldScale;
      posX = cx - (cx - posX) * ratio;
      posY = cy - (cy - posY) * ratio;
      updateTransform();
      showZoomLevel();
    }

    document.getElementById('zoom-in').addEventListener('click', (e) => {
      e.preventDefault();
      const cx = container.clientWidth / 2;
      const cy = container.clientHeight / 2;
      zoomAt(ZOOM_STEP, cx, cy);
    });

    document.getElementById('zoom-out').addEventListener('click', (e) => {
      e.preventDefault();
      const cx = container.clientWidth / 2;
      const cy = container.clientHeight / 2;
      zoomAt(-ZOOM_STEP, cx, cy);
    });

    document.getElementById('zoom-reset').addEventListener('click', (e) => {
      e.preventDefault();
      fitToScreen();
      showZoomLevel();
    });

    // Touch: panorera med ett finger
    container.addEventListener('touchstart', (e) => {
      if (joystickActive) return;
      if (e.touches.length === 1) {
        isDragging = true;
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
        startPosX = posX;
        startPosY = posY;
      }
    }, { passive: true });

    container.addEventListener('touchmove', (e) => {
      if (joystickActive) return;
      e.preventDefault();
      if (isDragging && e.touches.length === 1) {
        const dx = e.touches[0].clientX - startX;
        const dy = e.touches[0].clientY - startY;
        posX = startPosX + dx;
        posY = startPosY + dy;
        updateTransform();
      }
    }, { passive: false });

    container.addEventListener('touchend', () => {
      isDragging = false;
    });

    // Mouse: panorera med klick + drag
    container.addEventListener('mousedown', (e) => {
      isDragging = true;
      startX = e.clientX;
      startY = e.clientY;
      startPosX = posX;
      startPosY = posY;
    });

    window.addEventListener('mousemove', (e) => {
      if (!isDragging) return;
      const dx = e.clientX - startX;
      const dy = e.clientY - startY;
      posX = startPosX + dx;
      posY = startPosY + dy;
      updateTransform();
    });

    window.addEventListener('mouseup', () => {
      isDragging = false;
    });

    // Mouse wheel zoom
    container.addEventListener('wheel', (e) => {
      e.preventDefault();
      const delta = e.deltaY > 0 ? -ZOOM_STEP : ZOOM_STEP;
      zoomAt(delta, e.clientX, e.clientY);
    }, { passive: false });

    // === JOYSTICK ===
    const joystickBase = document.getElementById('joystick-base');
    const joystickKnob = document.getElementById('joystick-knob');
    let joystickAnimFrame = null;
    let joystickDX = 0;
    let joystickDY = 0;
    const JOYSTICK_MAX_OFFSET = 22;
    const JOYSTICK_PAN_SPEED = 6.0;

    function joystickStart(clientX, clientY, e) {
      e.preventDefault();
      e.stopPropagation();
      joystickActive = true;
      joystickMove(clientX, clientY);
      if (!joystickAnimFrame) joystickAnimate();
    }

    function joystickMove(clientX, clientY) {
      if (!joystickActive) return;
      const rect = joystickBase.getBoundingClientRect();
      const centerX = rect.left + rect.width / 2;
      const centerY = rect.top + rect.height / 2;
      let dx = clientX - centerX;
      let dy = clientY - centerY;
      const dist = Math.sqrt(dx * dx + dy * dy);
      if (dist > JOYSTICK_MAX_OFFSET) {
        dx = (dx / dist) * JOYSTICK_MAX_OFFSET;
        dy = (dy / dist) * JOYSTICK_MAX_OFFSET;
      }
      joystickDX = dx / JOYSTICK_MAX_OFFSET;
      joystickDY = dy / JOYSTICK_MAX_OFFSET;
      joystickKnob.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
    }

    function joystickEnd() {
      joystickActive = false;
      joystickDX = 0;
      joystickDY = 0;
      joystickKnob.style.transform = 'translate(-50%, -50%)';
      if (joystickAnimFrame) {
        cancelAnimationFrame(joystickAnimFrame);
        joystickAnimFrame = null;
      }
    }

    function joystickAnimate() {
      if (!joystickActive) {
        joystickAnimFrame = null;
        return;
      }
      var easedDX = Math.sign(joystickDX) * Math.pow(Math.abs(joystickDX), 2.5);
      var easedDY = Math.sign(joystickDY) * Math.pow(Math.abs(joystickDY), 2.5);
      posX -= easedDX * JOYSTICK_PAN_SPEED;
      posY -= easedDY * JOYSTICK_PAN_SPEED;
      updateTransform();
      joystickAnimFrame = requestAnimationFrame(joystickAnimate);
    }

    joystickKnob.addEventListener('touchstart', (e) => {
      const t = e.touches[0];
      joystickStart(t.clientX, t.clientY, e);
    }, { passive: false });

    window.addEventListener('touchmove', (e) => {
      if (joystickActive && e.touches.length === 1) {
        joystickMove(e.touches[0].clientX, e.touches[0].clientY);
      }
    }, { passive: true });

    window.addEventListener('touchend', (e) => {
      if (joystickActive) joystickEnd();
    });

    joystickKnob.addEventListener('mousedown', (e) => {
      joystickStart(e.clientX, e.clientY, e);
    });

    window.addEventListener('mousemove', (e) => {
      if (joystickActive) {
        joystickMove(e.clientX, e.clientY);
      }
    });

    window.addEventListener('mouseup', () => {
      if (joystickActive) joystickEnd();
    });

    window.addEventListener('resize', () => {
      if (imageLoaded) fitToScreen();
    });

    // ============================
    // GPS ‚Üí PIXEL KALIBRERING
    // ============================
    //
    // Referenspunkter: GPS-koordinater (lat, lng) ‚Üí pixel (x, y) p√• kartbilden (4000√ó2700)
    // Pixelkoordinater √§r uppskattade fr√•n visuell analys av kartbilden.
    // Dessa kan finjusteras ‚Äî se kalibreringsl√§get nedan.
    //
    const REFERENCE_POINTS = [
      // Lift M ‚Äî nedre v√§nster, vid "NORD"-omr√•det
      { id: 'M', lat: 61.880204, lng: 12.823573, px: 490, py: 1780 },
      // Lift H (den sydligare, 61.885) ‚Äî v√§nster-mitten
      { id: 'H1', lat: 61.885135, lng: 12.819700, px: 640, py: 680 },
      // Lift F ‚Äî uppe till v√§nster
      { id: 'F', lat: 61.887457, lng: 12.815602, px: 370, py: 430 },
      // Lift C ‚Äî mitten/toppen
      { id: 'C', lat: 61.890733, lng: 12.826176, px: 1220, py: 360 },
      // Lift H2 (den nordligare, 61.891) ‚Äî n√§ra C, lite norr/√∂st
      { id: 'H2', lat: 61.891180, lng: 12.828846, px: 1400, py: 310 },
      // Lift J ‚Äî mitt-√∂vre
      { id: 'J', lat: 61.890292, lng: 12.830380, px: 1510, py: 370 },
      // Lift L ‚Äî mitt-h√∂ger
      { id: 'L', lat: 61.891884, lng: 12.840278, px: 1870, py: 290 },
      // Lift B ‚Äî h√∂gst upp, nord√∂st
      { id: 'B', lat: 61.898811, lng: 12.849990, px: 2280, py: 150 },
      // Lift R ‚Äî sydv√§st, nere
      { id: 'R', lat: 61.876536, lng: 12.838049, px: 890, py: 2020 },
      // Lift T ‚Äî syd√∂st, nedre h√∂ger
      { id: 'T', lat: 61.882224, lng: 12.875592, px: 2480, py: 1550 },
      // Lift U ‚Äî √∂stra delen, uppe
      { id: 'U', lat: 61.888142, lng: 12.869819, px: 2260, py: 640 },
      // Lift V ‚Äî n√§ra U
      { id: 'V', lat: 61.888480, lng: 12.868481, px: 2200, py: 610 },
      // Lift X ‚Äî mitten
      { id: 'X', lat: 61.889510, lng: 12.851912, px: 1950, py: 440 },
      // Restaurang Utsikten (vid siffran 7)
      { id: 'Uts', lat: 61.887795, lng: 12.857254, px: 1760, py: 400 },
    ];

    // Ber√§kna affin transformationsmatris med minsta-kvadratmetoden
    // Mappar (lat, lng) ‚Üí (pixel_x, pixel_y) med 6-parametrig affin transform:
    //   px = a*lat + b*lng + c
    //   py = d*lat + e*lng + f
    function computeAffineTransform(points) {
      const n = points.length;
      // Vi l√∂ser tv√• separata system: ett f√∂r px, ett f√∂r py
      // [sum(lat^2)   sum(lat*lng) sum(lat) ] [a]   [sum(lat*px)]
      // [sum(lat*lng) sum(lng^2)   sum(lng) ] [b] = [sum(lng*px)]
      // [sum(lat)     sum(lng)     n        ] [c]   [sum(px)    ]

      let sLat2 = 0, sLng2 = 0, sLatLng = 0, sLat = 0, sLng = 0;
      let sLatPx = 0, sLngPx = 0, sPx = 0;
      let sLatPy = 0, sLngPy = 0, sPy = 0;

      for (const p of points) {
        sLat2 += p.lat * p.lat;
        sLng2 += p.lng * p.lng;
        sLatLng += p.lat * p.lng;
        sLat += p.lat;
        sLng += p.lng;
        sLatPx += p.lat * p.px;
        sLngPx += p.lng * p.px;
        sPx += p.px;
        sLatPy += p.lat * p.py;
        sLngPy += p.lng * p.py;
        sPy += p.py;
      }

      // Solve 3x3 linear system using Cramer's rule
      function solve3x3(A, b) {
        const det = A[0][0]*(A[1][1]*A[2][2]-A[1][2]*A[2][1])
                  - A[0][1]*(A[1][0]*A[2][2]-A[1][2]*A[2][0])
                  + A[0][2]*(A[1][0]*A[2][1]-A[1][1]*A[2][0]);
        if (Math.abs(det) < 1e-12) return null;

        const x = [];
        for (let i = 0; i < 3; i++) {
          const M = A.map(row => [...row]);
          for (let j = 0; j < 3; j++) M[j][i] = b[j];
          const di = M[0][0]*(M[1][1]*M[2][2]-M[1][2]*M[2][1])
                   - M[0][1]*(M[1][0]*M[2][2]-M[1][2]*M[2][0])
                   + M[0][2]*(M[1][0]*M[2][1]-M[1][1]*M[2][0]);
          x.push(di / det);
        }
        return x;
      }

      const A = [
        [sLat2, sLatLng, sLat],
        [sLatLng, sLng2, sLng],
        [sLat, sLng, n]
      ];

      const abcX = solve3x3(A, [sLatPx, sLngPx, sPx]);
      const abcY = solve3x3(A, [sLatPy, sLngPy, sPy]);

      if (!abcX || !abcY) return null;

      return {
        a: abcX[0], b: abcX[1], c: abcX[2],  // f√∂r pixel X
        d: abcY[0], e: abcY[1], f: abcY[2],   // f√∂r pixel Y
      };
    }

    const affine = computeAffineTransform(REFERENCE_POINTS);

    function gpsToPixel(lat, lng) {
      if (!affine) return { x: 0, y: 0 };
      return {
        x: affine.a * lat + affine.b * lng + affine.c,
        y: affine.d * lat + affine.e * lng + affine.f,
      };
    }

    // ============================
    // GRUPP/SESSION-SYSTEM
    // ============================
    const COLORS = [
      '#FF5252', '#448AFF', '#69F0AE', '#FFD740',
      '#E040FB', '#FF6E40', '#40C4FF', '#B2FF59',
    ];

    const markersOverlay = document.getElementById('markers-overlay');
    const sessionBar = document.getElementById('session-bar');
    const sessionRoomCode = document.getElementById('session-room-code');
    const sessionMemberCount = document.getElementById('session-member-count');
    const groupBtn = document.getElementById('group-btn');
    const groupBtnIcon = document.getElementById('group-btn-icon');
    const gpsStatusEl = document.getElementById('gps-status');

    let currentRoom = null;     // { code, ref }
    let myUserId = null;
    let myName = '';
    let myColor = COLORS[0];
    let gpsWatchId = null;
    let membersListener = null;
    let markers = {};           // userId ‚Üí DOM element

    // Ladda sparad profil
    function loadProfile() {
      try {
        const saved = JSON.parse(localStorage.getItem('pistkarta-profile'));
        if (saved) {
          myName = saved.name || '';
          myColor = saved.color || COLORS[0];
          myUserId = saved.userId || generateId();
        } else {
          myUserId = generateId();
        }
      } catch {
        myUserId = generateId();
      }
    }

    function saveProfile() {
      localStorage.setItem('pistkarta-profile', JSON.stringify({
        name: myName,
        color: myColor,
        userId: myUserId,
      }));
    }

    // Ladda senaste rummet (auto-rejoin)
    function loadLastRoom() {
      try {
        return JSON.parse(localStorage.getItem('pistkarta-room'));
      } catch {
        return null;
      }
    }

    function saveLastRoom(code, name) {
      localStorage.setItem('pistkarta-room', JSON.stringify({ code, name: name || '' }));
    }

    function clearLastRoom() {
      localStorage.removeItem('pistkarta-room');
    }

    function generateId() {
      return Math.random().toString(36).substring(2, 10);
    }

    function generateRoomCode() {
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      let code = '';
      for (let i = 0; i < 4; i++) {
        code += chars[Math.floor(Math.random() * chars.length)];
      }
      return code;
    }

    // ============================
    // FIREBASE-OPERATIONER
    // ============================
    function roomRef(code) {
      return db.ref(`pistkarta/rooms/${code}`);
    }

    function memberRef(code, userId) {
      return db.ref(`pistkarta/rooms/${code}/members/${userId}`);
    }

    async function createRoom(groupName) {
      const code = generateRoomCode();
      await roomRef(code).set({
        created: Date.now(),
        code: code,
        name: groupName || '',
      });
      return code;
    }

    async function roomExists(code) {
      const snap = await roomRef(code).once('value');
      return snap.exists();
    }

    async function joinRoom(code) {
      await memberRef(code, myUserId).set({
        name: myName,
        color: myColor,
        lat: 0,
        lng: 0,
        lastUpdate: Date.now(),
        online: true,
      });

      // Rensa min position vid disconnect
      memberRef(code, myUserId).child('online').onDisconnect().set(false);
      memberRef(code, myUserId).child('lastUpdate').onDisconnect().set(Date.now());

      askNotificationPermission();
    }

    async function leaveRoom() {
      if (!currentRoom) return;

      stopGPS();
      if (membersListener) {
        roomRef(currentRoom.code).child('members').off('value', membersListener);
        membersListener = null;
      }

      // Ta bort mig
      await memberRef(currentRoom.code, myUserId).remove();

      // Kolla om rummet √§r tomt ‚Äî radera i s√• fall
      const snap = await roomRef(currentRoom.code).child('members').once('value');
      if (!snap.exists() || !snap.val()) {
        await roomRef(currentRoom.code).remove();
      }

      currentRoom = null;
      clearLastRoom();
      clearAllMarkers();
      updateUI();
    }

    function updateMyPosition(lat, lng) {
      if (!currentRoom) return;
      memberRef(currentRoom.code, myUserId).update({
        lat: lat,
        lng: lng,
        lastUpdate: Date.now(),
        online: true,
      });
    }

    function listenToMembers(code) {
      if (membersListener) {
        roomRef(code).child('members').off('value', membersListener);
      }
      membersListener = roomRef(code).child('members').on('value', (snap) => {
        const members = snap.val() || {};
        lastMembersData = members;
        updateMarkers(members);
        updateSessionBar(members);
        if (membersPanelOpen) renderMembersList(members);
      });
    }

    // ============================
    // GPS-TRACKING
    // ============================
    function startGPS() {
      if (!navigator.geolocation) {
        showGpsStatus('GPS st√∂ds inte');
        return;
      }

      showGpsStatus('S√∂ker GPS...');

      gpsWatchId = navigator.geolocation.watchPosition(
        (pos) => {
          const { latitude, longitude, accuracy } = pos.coords;
          if (accuracy > 200) {
            showGpsStatus(`GPS: ~${Math.round(accuracy)}m (l√•g precision)`);
          } else {
            showGpsStatus(`GPS: ~${Math.round(accuracy)}m`);
            setTimeout(() => hideGpsStatus(), 3000);
          }
          updateMyPosition(latitude, longitude);
        },
        (err) => {
          console.warn('GPS-fel:', err);
          if (err.code === 1) {
            showGpsStatus('GPS nekad ‚Äî till√•t plats√•tkomst');
          } else {
            showGpsStatus('GPS-fel');
          }
        },
        {
          enableHighAccuracy: true,
          maximumAge: 5000,
          timeout: 10000,
        }
      );
    }

    function stopGPS() {
      if (gpsWatchId !== null) {
        navigator.geolocation.clearWatch(gpsWatchId);
        gpsWatchId = null;
      }
      hideGpsStatus();
    }

    function showGpsStatus(text) {
      gpsStatusEl.textContent = text;
      gpsStatusEl.classList.add('visible');
    }

    function hideGpsStatus() {
      gpsStatusEl.classList.remove('visible');
    }

    // ============================
    // MARK√ñRER P√Ö KARTAN
    // ============================
    function formatLastSeen(timestamp) {
      const diff = Date.now() - timestamp;
      const mins = Math.floor(diff / 60000);
      if (mins < 1) return 'just nu';
      if (mins < 60) return `${mins} min sedan`;
      const hours = Math.floor(mins / 60);
      if (hours < 24) return `${hours}h sedan`;
      return '√∂ver 1 dag sedan';
    }

    function updateMarkers(members) {
      const activeIds = new Set();

      for (const [userId, data] of Object.entries(members)) {
        if (!data || !data.name) continue;
        activeIds.add(userId);

        // Hoppa √∂ver offline anv√§ndare som inte uppdaterat p√• 10 min
        if (!data.online && (Date.now() - data.lastUpdate > 600000)) continue;

        // Hoppa √∂ver om ingen GPS-position (lat=0, lng=0)
        if (data.lat === 0 && data.lng === 0) continue;

        const pixel = gpsToPixel(data.lat, data.lng);

        if (markers[userId]) {
          // Uppdatera befintlig mark√∂r
          markers[userId].style.left = pixel.x + 'px';
          markers[userId].style.top = pixel.y + 'px';
          const dot = markers[userId].querySelector('.user-marker-dot');
          if (dot) {
            if (data.online) {
              dot.classList.remove('offline');
            } else {
              dot.classList.add('offline');
            }
          }
          // Uppdatera senast sedd
          const lastSeenEl = markers[userId].querySelector('.user-marker-lastseen');
          if (lastSeenEl) {
            if (!data.online && data.lastUpdate) {
              lastSeenEl.textContent = formatLastSeen(data.lastUpdate);
              lastSeenEl.style.display = 'block';
            } else {
              lastSeenEl.style.display = 'none';
            }
          }
        } else {
          // Skapa ny mark√∂r
          const el = document.createElement('div');
          el.className = 'user-marker';
          el.style.left = pixel.x + 'px';
          el.style.top = pixel.y + 'px';

          const dot = document.createElement('div');
          dot.className = 'user-marker-dot';
          dot.style.backgroundColor = data.color || '#FF5252';
          dot.style.borderColor = data.color || '#FF5252';
          if (!data.online) dot.classList.add('offline');

          const label = document.createElement('div');
          label.className = 'user-marker-label';
          label.textContent = userId === myUserId ? `${data.name} (du)` : data.name;

          const lastSeen = document.createElement('div');
          lastSeen.className = 'user-marker-lastseen';
          if (!data.online && data.lastUpdate) {
            lastSeen.textContent = formatLastSeen(data.lastUpdate);
            lastSeen.style.display = 'block';
          } else {
            lastSeen.style.display = 'none';
          }

          el.appendChild(dot);
          el.appendChild(label);
          el.appendChild(lastSeen);
          markersOverlay.appendChild(el);
          markers[userId] = el;
        }
      }

      // Ta bort mark√∂rer f√∂r medlemmar som l√§mnat
      for (const userId of Object.keys(markers)) {
        if (!activeIds.has(userId)) {
          markers[userId].remove();
          delete markers[userId];
        }
      }
    }

    function clearAllMarkers() {
      for (const el of Object.values(markers)) {
        el.remove();
      }
      markers = {};
    }

    // Uppdatera markers-overlay storlek
    function updateOverlaySize() {
      if (imgEl.naturalWidth) {
        markersOverlay.style.width = imgEl.naturalWidth + 'px';
        markersOverlay.style.height = imgEl.naturalHeight + 'px';
      }
    }

    const origFitToScreen = fitToScreen;
    // Koppla overlay-storlek till bildladdning
    imgEl.addEventListener('load', updateOverlaySize);

    // ============================
    // UI-HANTERING
    // ============================
    function updateUI() {
      if (currentRoom) {
        groupBtn.classList.add('active');
        groupBtnIcon.textContent = 'üìç';
        sessionBar.classList.add('visible');
        sessionRoomCode.textContent = currentRoom.name || currentRoom.code;
      } else {
        groupBtn.classList.remove('active');
        groupBtnIcon.textContent = 'üë•';
        sessionBar.classList.remove('visible');
      }
    }

    function updateSessionBar(members) {
      if (!members) return;
      const total = Object.keys(members).length;
      const onlineCount = Object.values(members).filter(m => m && m.online).length;
      sessionMemberCount.textContent = ` ¬∑ ${onlineCount}/${total} online`;
    }

    // Modaler
    function showModal(id) {
      document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('visible'));
      const modal = document.getElementById(id);
      if (modal) modal.classList.add('visible');
    }

    function hideAllModals() {
      document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('visible'));
    }

    // Fyll f√§rgv√§ljare
    function fillColorPicker(containerId) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      COLORS.forEach(color => {
        const el = document.createElement('div');
        el.className = 'color-option' + (color === myColor ? ' selected' : '');
        el.style.backgroundColor = color;
        el.addEventListener('click', () => {
          container.querySelectorAll('.color-option').forEach(c => c.classList.remove('selected'));
          el.classList.add('selected');
          myColor = color;
        });
        container.appendChild(el);
      });
    }

    // ============================
    // EVENT HANDLERS
    // ============================

    // Grupp-knapp
    groupBtn.addEventListener('click', () => {
      if (currentRoom) {
        // Visa gruppinfo
        showGroupInfo();
      } else {
        showModal('modal-menu');
      }
    });

    // Meny: Skapa grupp
    document.getElementById('btn-create-group').addEventListener('click', () => {
      document.getElementById('create-group-name').value = '';
      document.getElementById('create-name').value = myName;
      fillColorPicker('create-colors');
      showModal('modal-create');
    });

    // Meny: G√• med
    document.getElementById('btn-join-group').addEventListener('click', () => {
      document.getElementById('join-name').value = myName;
      document.getElementById('join-code').value = '';
      fillColorPicker('join-colors');
      showModal('modal-join');
    });

    // Avbryt
    document.getElementById('btn-cancel-menu').addEventListener('click', hideAllModals);
    document.getElementById('btn-back-create').addEventListener('click', () => showModal('modal-menu'));
    document.getElementById('btn-back-join').addEventListener('click', () => showModal('modal-menu'));
    document.getElementById('btn-close-info').addEventListener('click', hideAllModals);

    // Skapa grupp
    document.getElementById('btn-do-create').addEventListener('click', async () => {
      const groupNameInput = document.getElementById('create-group-name');
      const groupName = groupNameInput.value.trim();
      if (!groupName) {
        groupNameInput.focus();
        return;
      }

      const nameInput = document.getElementById('create-name');
      const name = nameInput.value.trim();
      if (!name) {
        nameInput.focus();
        return;
      }

      myName = name;
      saveProfile();

      const btn = document.getElementById('btn-do-create');
      btn.disabled = true;
      btn.textContent = 'Skapar...';

      try {
        const code = await createRoom(groupName);
        await joinRoom(code);
        currentRoom = { code, name: groupName };
        saveLastRoom(code, groupName);
        listenToMembers(code);
        startGPS();
        hideAllModals();
        updateUI();

        // Visa gruppinfo direkt s√• man kan dela koden
        setTimeout(() => showGroupInfo(), 300);
      } catch (err) {
        console.error('Kunde inte skapa rum:', err);
        alert('Kunde inte skapa grupp. F√∂rs√∂k igen.');
      }

      btn.disabled = false;
      btn.textContent = 'Skapa grupp';
    });

    // G√• med i grupp
    document.getElementById('btn-do-join').addEventListener('click', async () => {
      const codeInput = document.getElementById('join-code');
      const nameInput = document.getElementById('join-name');
      const code = codeInput.value.trim().toUpperCase();
      const name = nameInput.value.trim();

      if (!code || code.length < 4) { codeInput.focus(); return; }
      if (!name) { nameInput.focus(); return; }

      myName = name;
      saveProfile();

      const btn = document.getElementById('btn-do-join');
      btn.disabled = true;
      btn.textContent = 'Ansluter...';

      try {
        const roomSnap = await roomRef(code).once('value');
        if (!roomSnap.exists()) {
          alert('Gruppen hittades inte. Kontrollera koden.');
          btn.disabled = false;
          btn.textContent = 'G√• med';
          return;
        }

        const roomData = roomSnap.val();
        const roomName = roomData.name || '';
        await joinRoom(code);
        currentRoom = { code, name: roomName };
        saveLastRoom(code, roomName);
        listenToMembers(code);
        startGPS();
        hideAllModals();
        updateUI();
      } catch (err) {
        console.error('Kunde inte g√• med:', err);
        alert('Kunde inte ansluta. F√∂rs√∂k igen.');
      }

      btn.disabled = false;
      btn.textContent = 'G√• med';
    });

    // L√§mna grupp (session-bar)
    document.getElementById('session-leave').addEventListener('click', async () => {
      await leaveRoom();
    });

    // Gruppinfo
    function getShareUrl() {
      const base = window.location.origin + window.location.pathname;
      return base + '?group=' + currentRoom.code;
    }

    function showGroupInfo() {
      if (!currentRoom) return;
      document.getElementById('info-room-name').textContent = currentRoom.name || '';
      document.getElementById('info-room-code').textContent = currentRoom.code;

      // Visa delningsl√§nk
      const shareUrl = getShareUrl();
      document.getElementById('info-share-url').textContent = shareUrl;

      // Generera QR-kod
      const qrContainer = document.getElementById('info-qr-canvas');
      qrContainer.innerHTML = '';
      if (typeof QRCode !== 'undefined') {
        new QRCode(qrContainer, {
          text: shareUrl,
          width: 180,
          height: 180,
          colorDark: '#1a1a2e',
          colorLight: '#ffffff',
          correctLevel: QRCode.CorrectLevel.M
        });
      }

      // H√§mta medlemmar
      roomRef(currentRoom.code).child('members').once('value', (snap) => {
        const members = snap.val() || {};
        const membersEl = document.getElementById('info-members');
        membersEl.innerHTML = '';

        for (const [userId, data] of Object.entries(members)) {
          if (!data || !data.name) continue;
          const row = document.createElement('div');
          row.style.cssText = 'display:flex;align-items:center;gap:8px;padding:6px 0;';

          const dot = document.createElement('div');
          dot.style.cssText = `width:14px;height:14px;border-radius:50%;background:${data.color};flex-shrink:0;`;

          const nameEl = document.createElement('span');
          nameEl.style.cssText = 'font-size:15px;';
          nameEl.textContent = data.name + (userId === myUserId ? ' (du)' : '');

          const statusEl = document.createElement('span');
          statusEl.style.cssText = `font-size:11px;opacity:0.5;margin-left:auto;`;
          statusEl.textContent = data.online ? 'online' : 'offline';

          row.appendChild(dot);
          row.appendChild(nameEl);
          row.appendChild(statusEl);
          membersEl.appendChild(row);
        }
      });

      showModal('modal-info');
    }

    // Dela l√§nk
    document.getElementById('btn-share-code').addEventListener('click', async () => {
      if (!currentRoom) return;
      const shareUrl = getShareUrl();
      const groupLabel = currentRoom.name ? `gruppen "${currentRoom.name}"` : 'min grupp';
      const text = `G√• med i ${groupLabel} p√• Idre-pistkartan!`;

      if (navigator.share) {
        try {
          await navigator.share({ title: 'Idre Pistkarta', text, url: shareUrl });
        } catch {}
      } else {
        try {
          await navigator.clipboard.writeText(shareUrl);
          const btn = document.getElementById('btn-share-code');
          btn.textContent = '‚úÖ L√§nk kopierad!';
          setTimeout(() => { btn.textContent = 'üì§ Dela l√§nk'; }, 2000);
        } catch {
          prompt('Kopiera l√§nken:', shareUrl);
        }
      }
    });

    // L√§mna grupp (fr√•n info-modal)
    document.getElementById('btn-leave-group').addEventListener('click', async () => {
      hideAllModals();
      await leaveRoom();
    });

    // Auto-rejoin vid sidladdning
    loadProfile();
    const lastRoom = loadLastRoom();

    // Kolla om URL:en har en gruppkod (?group=XJKM)
    const urlParams = new URLSearchParams(window.location.search);
    const urlGroupCode = urlParams.get('group');

    if (urlGroupCode) {
      // Rensa URL-parametern utan att ladda om sidan
      const cleanUrl = window.location.origin + window.location.pathname;
      window.history.replaceState({}, '', cleanUrl);

      const code = urlGroupCode.toUpperCase().trim();

      // Kolla om vi redan √§r i denna grupp
      if (lastRoom && lastRoom.code === code) {
        // Auto-rejoin som vanligt
        roomRef(code).once('value').then(snap => {
          if (snap.exists()) {
            const roomData = snap.val();
            const roomName = roomData.name || lastRoom.name || '';
            joinRoom(code).then(() => {
              currentRoom = { code, name: roomName };
              saveLastRoom(code, roomName);
              listenToMembers(code);
              startGPS();
              updateUI();
            });
          }
        });
      } else {
        // Ny grupp via l√§nk ‚Äî visa join-modal med koden ifylld
        roomRef(code).once('value').then(snap => {
          if (snap.exists()) {
            const roomData = snap.val();
            const roomName = roomData.name || '';
            document.getElementById('join-code').value = code;
            document.getElementById('join-name').value = myName;
            fillColorPicker('join-colors');

            // Uppdatera modaltiteln med gruppnamnet
            const joinModal = document.querySelector('#modal-join .modal h2');
            if (joinModal && roomName) {
              joinModal.textContent = `G√• med i "${roomName}"`;
            }

            showModal('modal-join');
          } else {
            alert('Gruppen hittades inte. L√§nken kan vara felaktig eller gruppen kan ha tagits bort.');
          }
        });
      }
    } else if (lastRoom && lastRoom.code) {
      roomRef(lastRoom.code).once('value').then(snap => {
        if (snap.exists()) {
          const roomData = snap.val();
          const roomName = roomData.name || lastRoom.name || '';
          joinRoom(lastRoom.code).then(() => {
            currentRoom = { code: lastRoom.code, name: roomName };
            saveLastRoom(lastRoom.code, roomName);
            listenToMembers(lastRoom.code);
            startGPS();
            updateUI();
          });
        } else {
          clearLastRoom();
        }
      });
    }

    // St√§ng modal med klick utanf√∂r
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) hideAllModals();
      });
    });

    // Uppercase-transform f√∂r rumskods-input
    document.getElementById('join-code').addEventListener('input', (e) => {
      e.target.value = e.target.value.toUpperCase();
    });

    // ============================
    // GRUPP-CHATT
    // ============================

    const chatBtn        = document.getElementById('chat-btn');
    const chatBadge      = document.getElementById('chat-badge');
    const chatPanel      = document.getElementById('chat-panel');
    const chatPanelTitle = document.getElementById('chat-panel-title');
    const chatCloseBtn   = document.getElementById('chat-close-btn');
    const chatMessages   = document.getElementById('chat-messages');
    const chatInput      = document.getElementById('chat-input');
    const chatSendBtn    = document.getElementById('chat-send-btn');
    const attachBtn      = document.getElementById('attach-btn');
    const attachMenu     = document.getElementById('attach-menu');
    const voiceBtn       = document.getElementById('voice-btn');
    const imgFullscreen  = document.getElementById('img-fullscreen');
    const imgFullscreenImg = document.getElementById('img-fullscreen-img');

    let chatOpen = false;
    let unreadCount = 0;
    let chatListener = null;
    let lastRenderedMsgId = null;
    let isFirstLoad = true;

    // ---- Notifikationsljud ----
    function playNotificationSound() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const now = ctx.currentTime;

        // F√∂rsta ding
        const osc1 = ctx.createOscillator();
        const gain1 = ctx.createGain();
        osc1.connect(gain1);
        gain1.connect(ctx.destination);
        osc1.frequency.value = 880;
        osc1.type = 'sine';
        gain1.gain.setValueAtTime(0.5, now);
        gain1.gain.exponentialRampToValueAtTime(0.01, now + 0.25);
        osc1.start(now);
        osc1.stop(now + 0.25);

        // Andra ding (h√∂jt en kvint)
        const osc2 = ctx.createOscillator();
        const gain2 = ctx.createGain();
        osc2.connect(gain2);
        gain2.connect(ctx.destination);
        osc2.frequency.value = 1174;
        osc2.type = 'sine';
        gain2.gain.setValueAtTime(0.4, now + 0.2);
        gain2.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
        osc2.start(now + 0.2);
        osc2.stop(now + 0.5);
      } catch(e) {}

      // Vibrera
      try {
        if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
      } catch(e) {}
    }

    // ---- Web Notifications ----
    let notifPermissionAsked = false;
    function askNotificationPermission() {
      if (notifPermissionAsked) return;
      notifPermissionAsked = true;
      if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
      }
    }

    function showBrowserNotification(title, body) {
      try {
        if ('Notification' in window && Notification.permission === 'granted') {
          if (document.hidden) {
            new Notification(title, {
              body: body,
              icon: 'üí¨',
              tag: 'pistkarta-chat',
              renotify: true,
            });
          }
        }
      } catch(e) {}
    }

    // ---- Badge ----
    function updateChatBadge() {
      if (unreadCount > 0) {
        chatBadge.textContent = unreadCount > 99 ? '99+' : unreadCount;
        chatBadge.classList.add('visible');
      } else {
        chatBadge.classList.remove('visible');
      }
    }

    function resetUnread() {
      unreadCount = 0;
      updateChatBadge();
    }

    // ---- Tid-formatering ----
    function formatTime(ts) {
      const d = new Date(ts);
      const h = d.getHours().toString().padStart(2, '0');
      const m = d.getMinutes().toString().padStart(2, '0');
      return `${h}:${m}`;
    }

    // ---- Rendera ett meddelande ----
    function renderMessage(msgId, data) {
      const isMine = data.sender === myUserId;
      const msgEl = document.createElement('div');
      msgEl.className = 'chat-msg ' + (isMine ? 'mine' : 'theirs');
      msgEl.dataset.msgId = msgId;

      if (!isMine) {
        const sender = document.createElement('div');
        sender.className = 'chat-msg-sender';
        sender.style.color = data.senderColor || '#aaa';
        sender.textContent = data.senderName || 'Ok√§nd';
        msgEl.appendChild(sender);
      }

      const bubble = document.createElement('div');
      bubble.className = 'chat-msg-bubble';
      bubble.style.backgroundColor = isMine
        ? (data.senderColor || '#4CAF50')
        : 'rgba(255,255,255,0.1)';

      if (data.type === 'text') {
        bubble.textContent = data.text || '';

      } else if (data.type === 'image') {
        const img = document.createElement('img');
        img.className = 'chat-img';
        img.src = data.data;
        img.alt = data.fileName || 'Bild';
        img.addEventListener('click', () => openFullscreenImg(data.data));
        bubble.appendChild(img);

      } else if (data.type === 'file') {
        const link = document.createElement('a');
        link.className = 'chat-file-link';
        link.href = data.data;
        link.download = data.fileName || 'fil';
        link.addEventListener('click', e => e.stopPropagation());

        const icon = document.createElement('span');
        icon.className = 'chat-file-icon';
        icon.textContent = getFileIcon(data.mimeType || '');

        const info = document.createElement('div');
        info.className = 'chat-file-info';

        const fname = document.createElement('span');
        fname.className = 'chat-file-name';
        fname.textContent = data.fileName || 'Fil';

        const fsize = document.createElement('span');
        fsize.className = 'chat-file-size';
        fsize.textContent = data.fileSize ? formatBytes(data.fileSize) : '';

        info.appendChild(fname);
        info.appendChild(fsize);
        link.appendChild(icon);
        link.appendChild(info);
        bubble.appendChild(link);

      } else if (data.type === 'voice') {
        const audio = document.createElement('audio');
        audio.className = 'chat-audio';
        audio.controls = true;
        audio.src = data.data;
        audio.preload = 'none';
        bubble.appendChild(audio);
      }

      msgEl.appendChild(bubble);

      const time = document.createElement('div');
      time.className = 'chat-msg-time';
      time.textContent = formatTime(data.timestamp || Date.now());
      msgEl.appendChild(time);

      return msgEl;
    }

    function getFileIcon(mime) {
      if (mime.startsWith('image/')) return 'üñº';
      if (mime === 'application/pdf') return 'üìÑ';
      if (mime.includes('word') || mime.includes('document')) return 'üìù';
      if (mime.includes('sheet') || mime.includes('excel')) return 'üìä';
      if (mime.includes('zip') || mime.includes('rar') || mime.includes('7z')) return 'üóú';
      return 'üìé';
    }

    function formatBytes(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1048576) return (bytes / 1024).toFixed(0) + ' KB';
      return (bytes / 1048576).toFixed(1) + ' MB';
    }

    function scrollToBottom(smooth) {
      if (smooth) {
        chatMessages.scrollTo({ top: chatMessages.scrollHeight, behavior: 'smooth' });
      } else {
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
    }

    function openFullscreenImg(src) {
      imgFullscreenImg.src = src;
      imgFullscreen.classList.add('visible');
    }

    imgFullscreen.addEventListener('click', () => {
      imgFullscreen.classList.remove('visible');
      imgFullscreenImg.src = '';
    });

    // ---- Firebase-lyssnare f√∂r chatt ----
    function startChatListener(code) {
      stopChatListener();
      isFirstLoad = true;
      chatMessages.innerHTML = '';
      lastRenderedMsgId = null;

      const ref = db.ref(`pistkarta/rooms/${code}/messages`).limitToLast(100);

      chatListener = ref.on('child_added', (snap) => {
        const data = snap.val();
        const msgId = snap.key;
        if (!data) return;

        // Hoppa √∂ver dubblett
        if (chatMessages.querySelector(`[data-msg-id="${msgId}"]`)) return;

        const msgEl = renderMessage(msgId, data);

        // Hitta r√§tt position (sortera efter timestamp)
        let inserted = false;
        const children = chatMessages.querySelectorAll('.chat-msg');
        for (let i = children.length - 1; i >= 0; i--) {
          const existingId = children[i].dataset.msgId;
          const existingSnap = children[i].dataset.ts;
          const existingTs = existingSnap ? parseInt(existingSnap) : 0;
          if ((data.timestamp || 0) >= existingTs) {
            children[i].insertAdjacentElement('afterend', msgEl);
            inserted = true;
            break;
          }
        }
        if (!inserted) chatMessages.prepend(msgEl);
        msgEl.dataset.ts = data.timestamp || 0;

        if (isFirstLoad) {
          // Inledande laddning ‚Äî scrolla direkt utan animation
          scrollToBottom(false);
        } else {
          // Nytt meddelande
          const atBottom = chatMessages.scrollHeight - chatMessages.scrollTop - chatMessages.clientHeight < 60;
          if (atBottom || data.sender === myUserId) {
            scrollToBottom(true);
          }

          if (!chatOpen) {
            // Meddela bara om chatten √§r st√§ngd och det √§r en annans meddelande
            if (data.sender !== myUserId) {
              unreadCount++;
              updateChatBadge();
              playNotificationSound();
              showBrowserNotification(
                currentRoom?.name || 'Gruppchatt',
                `${data.senderName}: ${data.type === 'text' ? data.text : (data.type === 'image' ? 'üì∑ Bild' : data.type === 'voice' ? 'üé§ R√∂stmeddelande' : 'üìé Fil')}`
              );
            }
          }
        }
      });

      // Markera att initial laddning √§r klar efter en kort stund
      ref.once('value', () => {
        isFirstLoad = false;
        scrollToBottom(false);
      });
    }

    function stopChatListener() {
      if (chatListener && currentRoom) {
        db.ref(`pistkarta/rooms/${currentRoom.code}/messages`).off('child_added', chatListener);
      }
      chatListener = null;
    }

    // ---- √ñppna/st√§ng chatt ----
    function openChat() {
      chatOpen = true;
      chatPanel.classList.add('open');
      resetUnread();
      setTimeout(() => {
        scrollToBottom(false);
        chatInput.focus();
      }, 360);
    }

    function closeChat() {
      chatOpen = false;
      chatPanel.classList.remove('open');
      closeAttachMenu();
    }

    chatBtn.addEventListener('click', () => {
      if (chatOpen) {
        closeChat();
      } else {
        openChat();
      }
    });

    chatCloseBtn.addEventListener('click', closeChat);

    // St√§ng chatten om man trycker utanf√∂r (p√• kartan)
    document.getElementById('map-container').addEventListener('touchstart', () => {
      if (chatOpen) closeChat();
    }, { passive: true });

    // ---- Skicka textmeddelande ----
    function sendTextMessage(text) {
      if (!currentRoom || !text.trim()) return;
      const ref = db.ref(`pistkarta/rooms/${currentRoom.code}/messages`).push();
      ref.set({
        type: 'text',
        sender: myUserId,
        senderName: myName,
        senderColor: myColor,
        text: text.trim(),
        timestamp: Date.now(),
      });
    }

    chatSendBtn.addEventListener('click', () => {
      const text = chatInput.value.trim();
      if (!text) return;
      sendTextMessage(text);
      chatInput.value = '';
      chatInput.focus();
    });

    chatInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        const text = chatInput.value.trim();
        if (!text) return;
        sendTextMessage(text);
        chatInput.value = '';
      }
    });

    // touch-action: auto p√• inputf√§lt (till√•t scroll + tangentbord)
    chatInput.style.touchAction = 'auto';

    // ---- Bifoga-meny ----
    function openAttachMenu() {
      attachMenu.classList.add('open');
    }

    function closeAttachMenu() {
      attachMenu.classList.remove('open');
    }

    attachBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      if (attachMenu.classList.contains('open')) {
        closeAttachMenu();
      } else {
        openAttachMenu();
      }
    });

    // St√§ng bifoga-menyn vid klick utanf√∂r
    document.addEventListener('click', (e) => {
      if (!attachMenu.contains(e.target) && e.target !== attachBtn) {
        closeAttachMenu();
      }
    });

    // Kamera
    document.getElementById('attach-camera').addEventListener('click', () => {
      closeAttachMenu();
      document.getElementById('file-input-camera').click();
    });

    // Bild fr√•n bibliotek
    document.getElementById('attach-image').addEventListener('click', () => {
      closeAttachMenu();
      document.getElementById('file-input-image').click();
    });

    // Fil
    document.getElementById('attach-file').addEventListener('click', () => {
      closeAttachMenu();
      document.getElementById('file-input-file').click();
    });

    // ---- Bildkomprimering ----
    function compressImage(file, maxW, maxH, quality) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            let w = img.width;
            let h = img.height;
            if (w > maxW || h > maxH) {
              const ratio = Math.min(maxW / w, maxH / h);
              w = Math.round(w * ratio);
              h = Math.round(h * ratio);
            }
            const canvas = document.createElement('canvas');
            canvas.width = w;
            canvas.height = h;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, w, h);
            const dataUrl = canvas.toDataURL('image/jpeg', quality);
            resolve(dataUrl);
          };
          img.onerror = reject;
          img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // ---- Skicka bild ----
    async function sendImageFile(file) {
      if (!currentRoom) return;
      try {
        const dataUrl = await compressImage(file, 800, 800, 0.6);
        // ~1.5 MB gr√§ns p√• base64 (ca 2MB r√• data)
        if (dataUrl.length > 2000000) {
          alert('Bilden √§r f√∂r stor efter komprimering. V√§lj en mindre bild.');
          return;
        }
        const ref = db.ref(`pistkarta/rooms/${currentRoom.code}/messages`).push();
        ref.set({
          type: 'image',
          sender: myUserId,
          senderName: myName,
          senderColor: myColor,
          data: dataUrl,
          fileName: file.name,
          mimeType: 'image/jpeg',
          timestamp: Date.now(),
        });
      } catch(e) {
        alert('Kunde inte skicka bilden. F√∂rs√∂k igen.');
        console.error(e);
      }
    }

    // ---- Skicka fil ----
    async function sendGenericFile(file) {
      if (!currentRoom) return;
      const MAX_SIZE = 2 * 1024 * 1024; // 2 MB
      if (file.size > MAX_SIZE) {
        alert(`Filen √§r f√∂r stor (max 2 MB). Filens storlek: ${formatBytes(file.size)}`);
        return;
      }
      const reader = new FileReader();
      reader.onload = (e) => {
        const dataUrl = e.target.result;
        const ref = db.ref(`pistkarta/rooms/${currentRoom.code}/messages`).push();
        ref.set({
          type: 'file',
          sender: myUserId,
          senderName: myName,
          senderColor: myColor,
          data: dataUrl,
          fileName: file.name,
          mimeType: file.type || 'application/octet-stream',
          fileSize: file.size,
          timestamp: Date.now(),
        });
      };
      reader.onerror = () => alert('Kunde inte l√§sa filen.');
      reader.readAsDataURL(file);
    }

    // File inputs
    document.getElementById('file-input-camera').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) sendImageFile(file);
      e.target.value = '';
    });

    document.getElementById('file-input-image').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) sendImageFile(file);
      e.target.value = '';
    });

    document.getElementById('file-input-file').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      if (file.type.startsWith('image/')) {
        sendImageFile(file);
      } else {
        sendGenericFile(file);
      }
      e.target.value = '';
    });

    // ---- R√∂stinspelning ----
    let mediaRecorder = null;
    let audioChunks = [];
    let voiceTimeout = null;
    let isRecording = false;

    async function startRecording() {
      if (isRecording) return;
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const mimeType = MediaRecorder.isTypeSupported('audio/webm;codecs=opus')
          ? 'audio/webm;codecs=opus'
          : MediaRecorder.isTypeSupported('audio/mp4')
            ? 'audio/mp4'
            : 'audio/webm';

        mediaRecorder = new MediaRecorder(stream, { mimeType });
        audioChunks = [];

        mediaRecorder.addEventListener('dataavailable', (e) => {
          if (e.data && e.data.size > 0) audioChunks.push(e.data);
        });

        mediaRecorder.addEventListener('stop', () => {
          stream.getTracks().forEach(t => t.stop());
          if (audioChunks.length > 0) {
            const blob = new Blob(audioChunks, { type: mimeType });
            sendVoiceMessage(blob, mimeType);
          }
          audioChunks = [];
        });

        mediaRecorder.start(100);
        isRecording = true;
        voiceBtn.classList.add('recording');

        // Max 30 sekunder
        voiceTimeout = setTimeout(() => {
          if (isRecording) stopRecording();
        }, 30000);

      } catch(e) {
        console.error('Mikrofon-fel:', e);
        alert('Kunde inte komma √•t mikrofonen. Kontrollera beh√∂righeter.');
      }
    }

    function stopRecording() {
      if (!isRecording || !mediaRecorder) return;
      clearTimeout(voiceTimeout);
      isRecording = false;
      voiceBtn.classList.remove('recording');
      if (mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
      }
      mediaRecorder = null;
    }

    function sendVoiceMessage(blob, mimeType) {
      if (!currentRoom) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        const dataUrl = e.target.result;
        if (dataUrl.length > 2000000) {
          alert('R√∂stmeddelandet √§r f√∂r l√•ngt (max ~30 sek).');
          return;
        }
        const ref = db.ref(`pistkarta/rooms/${currentRoom.code}/messages`).push();
        ref.set({
          type: 'voice',
          sender: myUserId,
          senderName: myName,
          senderColor: myColor,
          data: dataUrl,
          mimeType: mimeType,
          timestamp: Date.now(),
        });
      };
      reader.readAsDataURL(blob);
    }

    // Touch-h√•ll p√• r√∂st-knappen = spela in
    voiceBtn.addEventListener('touchstart', (e) => {
      e.preventDefault();
      startRecording();
    }, { passive: false });

    voiceBtn.addEventListener('touchend', (e) => {
      e.preventDefault();
      stopRecording();
    }, { passive: false });

    voiceBtn.addEventListener('touchcancel', (e) => {
      e.preventDefault();
      stopRecording();
    }, { passive: false });

    // Desktop: mousedown/mouseup
    voiceBtn.addEventListener('mousedown', (e) => {
      e.preventDefault();
      startRecording();
    });

    voiceBtn.addEventListener('mouseup', () => {
      stopRecording();
    });

    voiceBtn.addEventListener('mouseleave', () => {
      if (isRecording) stopRecording();
    });

    // ============================
    // GRUPPLISTA-PANEL
    // ============================
    const membersBtn = document.getElementById('members-btn');
    const membersPanel = document.getElementById('members-panel');
    const membersList = document.getElementById('members-list');
    const membersPanelTitle = document.getElementById('members-panel-title');
    const membersCloseBtn = document.getElementById('members-close-btn');
    let membersPanelOpen = false;
    let lastMembersData = null;

    function openMembersPanel() {
      membersPanelOpen = true;
      membersPanel.classList.add('open');
      if (lastMembersData) renderMembersList(lastMembersData);
    }

    function closeMembersPanel() {
      membersPanelOpen = false;
      membersPanel.classList.remove('open');
    }

    membersBtn.addEventListener('click', () => {
      if (membersPanelOpen) {
        closeMembersPanel();
      } else {
        // St√§ng chatten om den √§r √∂ppen
        if (chatOpen) closeChat();
        openMembersPanel();
      }
    });

    membersCloseBtn.addEventListener('click', closeMembersPanel);

    document.getElementById('map-container').addEventListener('touchstart', () => {
      if (membersPanelOpen) closeMembersPanel();
    }, { passive: true });

    function renderMembersList(members) {
      membersList.innerHTML = '';
      const sorted = Object.entries(members).sort((a, b) => {
        // Online f√∂rst, sedan efter namn
        if (a[1].online && !b[1].online) return -1;
        if (!a[1].online && b[1].online) return 1;
        return (a[1].name || '').localeCompare(b[1].name || '');
      });

      for (const [userId, data] of sorted) {
        if (!data || !data.name) continue;
        const row = document.createElement('div');
        row.className = 'member-row';

        const dot = document.createElement('div');
        dot.className = 'member-dot' + (data.online ? ' online' : '');
        dot.style.backgroundColor = data.color || '#FF5252';
        dot.style.color = data.color || '#FF5252';

        const info = document.createElement('div');
        info.className = 'member-info';

        const name = document.createElement('div');
        name.className = 'member-name';
        name.textContent = data.name + (userId === myUserId ? ' (du)' : '');

        const status = document.createElement('div');
        status.className = 'member-status' + (data.online ? ' online' : '');
        if (data.online) {
          status.textContent = '‚óè Live nu';
        } else if (data.lastUpdate) {
          status.textContent = '‚óã ' + formatLastSeen(data.lastUpdate);
        } else {
          status.textContent = '‚óã Offline';
        }

        info.appendChild(name);
        info.appendChild(status);
        row.appendChild(dot);
        row.appendChild(info);
        membersList.appendChild(row);
      }
    }

    // ---- Integrera med grupp-systemet ----
    // Patcha updateUI f√∂r att visa/d√∂lja chatt-knappen och starta/stoppa lyssnare
    const _originalUpdateUI = updateUI;
    updateUI = function() {
      _originalUpdateUI();
      if (currentRoom) {
        chatBtn.classList.add('visible');
        membersBtn.classList.add('visible');
        chatPanelTitle.textContent = currentRoom.name ? `${currentRoom.name} ‚Äî Chatt` : 'Gruppchatt';
        startChatListener(currentRoom.code);
      } else {
        chatBtn.classList.remove('visible');
        membersBtn.classList.remove('visible');
        closeChat();
        closeMembersPanel();
        stopChatListener();
        chatMessages.innerHTML = '';
        resetUnread();
      }
    };

    // Patcha leaveRoom f√∂r att rensa chatt-lyssnare
    const _originalLeaveRoom = leaveRoom;
    leaveRoom = async function() {
      closeChat();
      stopChatListener();
      await _originalLeaveRoom();
    };

    // Om man redan √§r i ett rum n√§r sidan laddas (auto-rejoin)
    // updateUI() kallas redan i auto-rejoin-koden, men vi m√•ste se till att
    // v√•r patchade version anropas. Eftersom leaveRoom och updateUI √§r omtilldelade
    // till nya funktioner fungerar detta korrekt f√∂r nya h√§ndelser.
    // Men f√∂r auto-rejoin som sker innan patchen: kontrollera vid DOMContentLoaded.
    // Vi l√∂ser det med en liten f√∂rdr√∂jning som garanterar att patchen hunnit appliceras.
    setTimeout(() => {
      if (currentRoom) {
        chatBtn.classList.add('visible');
        membersBtn.classList.add('visible');
        chatPanelTitle.textContent = currentRoom.name ? `${currentRoom.name} ‚Äî Chatt` : 'Gruppchatt';
        startChatListener(currentRoom.code);
      }
    }, 500);

  </script>
</body>
</html>
