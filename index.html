<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>Idre Fjäll — Pistkarta</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      touch-action: none;
    }

    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #1a1a2e;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    }

    #map-container {
      width: 100%;
      height: 100%;
      overflow: hidden;
      position: relative;
    }

    #map {
      position: absolute;
      transform-origin: 0 0;
      cursor: grab;
      will-change: transform;
    }

    #map:active {
      cursor: grabbing;
    }

    #map img {
      display: block;
      max-width: none;
    }

    /* Zoom-knappar — nere till höger, ovanför joystick */
    .zoom-controls {
      position: fixed;
      bottom: 152px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      z-index: 100;
    }

    .zoom-btn {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      border: none;
      background: rgba(255, 255, 255, 0.92);
      color: #1a1a2e;
      font-size: 32px;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      transition: transform 0.1s ease, background 0.15s ease;
    }

    .zoom-btn:active {
      transform: scale(0.92);
      background: rgba(200, 200, 255, 0.95);
    }

    /* Reset-knapp */
    .reset-btn {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      border: none;
      background: rgba(255, 255, 255, 0.7);
      color: #1a1a2e;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      transition: transform 0.1s ease;
    }

    .reset-btn:active {
      transform: scale(0.92);
    }

    /* Joystick */
    .joystick-container {
      position: fixed;
      bottom: 32px;
      right: 20px;
      z-index: 100;
    }

    .joystick-base {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.25);
      border: 2px solid rgba(255, 255, 255, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .joystick-knob {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.9);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      cursor: grab;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      transition: background 0.15s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .joystick-knob:active {
      background: rgba(200, 200, 255, 0.95);
      cursor: grabbing;
    }

    .joystick-knob::after {
      content: '✦';
      font-size: 18px;
      color: #1a1a2e;
      opacity: 0.5;
    }

    /* Laddningsmeddelande */
    #loading {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #1a1a2e;
      color: white;
      font-size: 18px;
      z-index: 200;
      gap: 16px;
    }

    #loading.hidden {
      display: none;
    }

    #loading .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255,255,255,0.2);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Placeholder om ingen bild finns */
    #placeholder {
      display: none;
      position: fixed;
      inset: 0;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #1a1a2e;
      color: white;
      text-align: center;
      padding: 32px;
      gap: 16px;
      z-index: 200;
    }

    #placeholder h2 {
      font-size: 24px;
    }

    #placeholder p {
      font-size: 16px;
      opacity: 0.7;
      max-width: 320px;
      line-height: 1.5;
    }

    /* Zoom-nivå indikator */
    #zoom-level {
      position: fixed;
      top: 16px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.6);
      color: white;
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 14px;
      z-index: 100;
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }

    #zoom-level.visible {
      opacity: 1;
    }
  </style>
</head>
<body>
  <div id="loading">
    <div class="spinner"></div>
    <span>Laddar pistkarta...</span>
  </div>

  <div id="placeholder">
    <h2>⛷️ Pistkarta</h2>
    <p>Lägg kartbilden som <strong>pistkarta.jpg</strong> i samma mapp som denna fil.</p>
    <p style="font-size: 13px; opacity: 0.5;">Stöder: .jpg, .png, .webp</p>
  </div>

  <div id="map-container">
    <div id="map">
      <img id="map-img" alt="Pistkarta Idre Fjäll">
    </div>
  </div>

  <div id="zoom-level"></div>

  <div class="zoom-controls">
    <button class="reset-btn" id="zoom-reset" aria-label="Återställ vy">⟲</button>
    <button class="zoom-btn" id="zoom-in" aria-label="Zooma in">+</button>
    <button class="zoom-btn" id="zoom-out" aria-label="Zooma ut">−</button>
  </div>

  <div class="joystick-container">
    <div class="joystick-base" id="joystick-base">
      <div class="joystick-knob" id="joystick-knob"></div>
    </div>
  </div>

  <script>
    const mapEl = document.getElementById('map');
    const imgEl = document.getElementById('map-img');
    const container = document.getElementById('map-container');
    const loading = document.getElementById('loading');
    const placeholder = document.getElementById('placeholder');
    const zoomLevelEl = document.getElementById('zoom-level');

    // State
    let scale = 1;
    let posX = 0;
    let posY = 0;
    let isDragging = false;
    let startX, startY, startPosX, startPosY;
    let zoomTimeout;

    // Joystick state (deklareras tidigt så touch-hanterare kan referera)
    let joystickActive = false;

    const MIN_SCALE = 0.5;
    const MAX_SCALE = 6;
    const ZOOM_STEP = 0.25;

    // Försök ladda bild
    const imageCandidates = ['pistkarta.webp', 'pistkarta.jpg', 'pistkarta.png'];
    let imageLoaded = false;

    function tryLoadImage(index) {
      if (index >= imageCandidates.length) {
        loading.classList.add('hidden');
        placeholder.style.display = 'flex';
        return;
      }

      const testImg = new Image();
      testImg.onload = function() {
        imageLoaded = true;
        imgEl.src = imageCandidates[index];
        loading.classList.add('hidden');
        fitToScreen();
      };
      testImg.onerror = function() {
        tryLoadImage(index + 1);
      };
      testImg.src = imageCandidates[index];
    }

    tryLoadImage(0);

    function fitToScreen() {
      const cw = container.clientWidth;
      const ch = container.clientHeight;
      const iw = imgEl.naturalWidth;
      const ih = imgEl.naturalHeight;

      scale = Math.min(cw / iw, ch / ih);
      posX = (cw - iw * scale) / 2;
      posY = (ch - ih * scale) / 2;

      updateTransform();
    }

    function updateTransform() {
      mapEl.style.transform = `translate(${posX}px, ${posY}px) scale(${scale})`;
    }

    function showZoomLevel() {
      const percent = Math.round(scale * 100);
      zoomLevelEl.textContent = `${percent}%`;
      zoomLevelEl.classList.add('visible');
      clearTimeout(zoomTimeout);
      zoomTimeout = setTimeout(() => {
        zoomLevelEl.classList.remove('visible');
      }, 1200);
    }

    function zoomAt(delta, cx, cy) {
      const oldScale = scale;
      scale = Math.min(MAX_SCALE, Math.max(MIN_SCALE, scale + delta));

      // Zooma mot centrum av skärmen (eller angiven punkt)
      const ratio = scale / oldScale;
      posX = cx - (cx - posX) * ratio;
      posY = cy - (cy - posY) * ratio;

      updateTransform();
      showZoomLevel();
    }

    // Knappar
    document.getElementById('zoom-in').addEventListener('click', (e) => {
      e.preventDefault();
      const cx = container.clientWidth / 2;
      const cy = container.clientHeight / 2;
      zoomAt(ZOOM_STEP, cx, cy);
    });

    document.getElementById('zoom-out').addEventListener('click', (e) => {
      e.preventDefault();
      const cx = container.clientWidth / 2;
      const cy = container.clientHeight / 2;
      zoomAt(-ZOOM_STEP, cx, cy);
    });

    document.getElementById('zoom-reset').addEventListener('click', (e) => {
      e.preventDefault();
      fitToScreen();
      showZoomLevel();
    });

    // Touch: panorera med ett finger (inte om joystick är aktiv)
    container.addEventListener('touchstart', (e) => {
      if (joystickActive) return;
      if (e.touches.length === 1) {
        isDragging = true;
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
        startPosX = posX;
        startPosY = posY;
      }
    }, { passive: true });

    container.addEventListener('touchmove', (e) => {
      if (joystickActive) return;
      e.preventDefault();
      if (isDragging && e.touches.length === 1) {
        const dx = e.touches[0].clientX - startX;
        const dy = e.touches[0].clientY - startY;
        posX = startPosX + dx;
        posY = startPosY + dy;
        updateTransform();
      }
    }, { passive: false });

    container.addEventListener('touchend', () => {
      isDragging = false;
    });

    // Mouse: panorera med klick + drag
    container.addEventListener('mousedown', (e) => {
      isDragging = true;
      startX = e.clientX;
      startY = e.clientY;
      startPosX = posX;
      startPosY = posY;
    });

    window.addEventListener('mousemove', (e) => {
      if (!isDragging) return;
      const dx = e.clientX - startX;
      const dy = e.clientY - startY;
      posX = startPosX + dx;
      posY = startPosY + dy;
      updateTransform();
    });

    window.addEventListener('mouseup', () => {
      isDragging = false;
    });

    // Mouse wheel zoom
    container.addEventListener('wheel', (e) => {
      e.preventDefault();
      const delta = e.deltaY > 0 ? -ZOOM_STEP : ZOOM_STEP;
      zoomAt(delta, e.clientX, e.clientY);
    }, { passive: false });

    // === JOYSTICK ===
    const joystickBase = document.getElementById('joystick-base');
    const joystickKnob = document.getElementById('joystick-knob');
    let joystickAnimFrame = null;
    let joystickDX = 0;
    let joystickDY = 0;
    const JOYSTICK_MAX_OFFSET = 22; // max pixels knob moves from center
    const JOYSTICK_PAN_SPEED = 2.5; // pixels per frame — lagom speed

    function joystickStart(clientX, clientY, e) {
      e.preventDefault();
      e.stopPropagation();
      joystickActive = true;
      joystickMove(clientX, clientY);
      if (!joystickAnimFrame) joystickAnimate();
    }

    function joystickMove(clientX, clientY) {
      if (!joystickActive) return;
      const rect = joystickBase.getBoundingClientRect();
      const centerX = rect.left + rect.width / 2;
      const centerY = rect.top + rect.height / 2;

      let dx = clientX - centerX;
      let dy = clientY - centerY;

      // Clamp to max offset
      const dist = Math.sqrt(dx * dx + dy * dy);
      if (dist > JOYSTICK_MAX_OFFSET) {
        dx = (dx / dist) * JOYSTICK_MAX_OFFSET;
        dy = (dy / dist) * JOYSTICK_MAX_OFFSET;
      }

      joystickDX = dx / JOYSTICK_MAX_OFFSET; // -1 to 1
      joystickDY = dy / JOYSTICK_MAX_OFFSET;

      // Move knob visually
      joystickKnob.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
    }

    function joystickEnd() {
      joystickActive = false;
      joystickDX = 0;
      joystickDY = 0;
      joystickKnob.style.transform = 'translate(-50%, -50%)';
      if (joystickAnimFrame) {
        cancelAnimationFrame(joystickAnimFrame);
        joystickAnimFrame = null;
      }
    }

    function joystickAnimate() {
      if (!joystickActive) {
        joystickAnimFrame = null;
        return;
      }
      // INVERTERAT: dra vänster → kartan rör sig höger
      posX -= joystickDX * JOYSTICK_PAN_SPEED;
      posY -= joystickDY * JOYSTICK_PAN_SPEED;
      updateTransform();
      joystickAnimFrame = requestAnimationFrame(joystickAnimate);
    }

    // Touch events for joystick
    joystickKnob.addEventListener('touchstart', (e) => {
      const t = e.touches[0];
      joystickStart(t.clientX, t.clientY, e);
    }, { passive: false });

    window.addEventListener('touchmove', (e) => {
      if (joystickActive && e.touches.length === 1) {
        joystickMove(e.touches[0].clientX, e.touches[0].clientY);
      }
    }, { passive: true });

    window.addEventListener('touchend', (e) => {
      if (joystickActive) joystickEnd();
    });

    // Mouse events for joystick (desktop testing)
    joystickKnob.addEventListener('mousedown', (e) => {
      joystickStart(e.clientX, e.clientY, e);
    });

    window.addEventListener('mousemove', (e) => {
      if (joystickActive) {
        joystickMove(e.clientX, e.clientY);
      }
    });

    window.addEventListener('mouseup', () => {
      if (joystickActive) joystickEnd();
    });

    // Resize
    window.addEventListener('resize', () => {
      if (imageLoaded) fitToScreen();
    });
  </script>
</body>
</html>
